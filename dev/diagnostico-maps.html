<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Google Maps API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .log-entry {
            font-family: 'Courier New', monospace;
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
            font-size: 13px;
        }
        .log-success { background: #d1fae5; color: #065f46; }
        .log-error { background: #fee2e2; color: #991b1b; }
        .log-warning { background: #fef3c7; color: #92400e; }
        .log-info { background: #dbeafe; color: #1e40af; }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">üîç Diagn√≥stico Google Maps API</h1>
            <p class="text-gray-600">Testando conex√£o e autentica√ß√£o com a API do Google Maps</p>
        </div>

        <!-- Informa√ß√µes da API Key -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Chave API Configurada</h2>
            <div class="bg-gray-50 p-4 rounded-lg">
                <p class="text-sm text-gray-600 mb-2">Chave:</p>
                <p id="api-key-display" class="font-mono text-sm bg-white p-2 rounded border"></p>
            </div>
        </div>

        <!-- Log de Diagn√≥stico -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Log de Diagn√≥stico</h2>
            <div id="diagnostic-log" class="space-y-2 max-h-96 overflow-y-auto"></div>
        </div>

        <!-- Teste Simples -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Teste R√°pido de Geocodifica√ß√£o</h2>
            <p class="text-sm text-gray-600 mb-4">Testar se a API consegue geocodificar um endere√ßo simples</p>
            <input
                type="text"
                id="endereco-teste"
                value="Recife, PE, Brasil"
                class="w-full px-3 py-2 border border-gray-300 rounded-md mb-3"
            >
            <button onclick="testarGeocodificacao()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                Testar Geocodifica√ß√£o
            </button>
            <div id="resultado-geo" class="mt-4"></div>
        </div>

        <!-- Mapa de Teste -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Mapa de Teste</h2>
            <div id="map" class="w-full h-96 bg-gray-200 rounded-lg"></div>
        </div>
    </div>

    <script>
        const API_KEY = 'AIzaSyDosD-8buFssKmkoSQCtqNKskkvtn_5E6E';
        let logContainer;
        let geocoder;

        // Fun√ß√µes de log
        function log(message, type = 'info') {
            if (!logContainer) {
                logContainer = document.getElementById('diagnostic-log');
            }

            const timestamp = new Date().toLocaleTimeString('pt-BR');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;

            // Tamb√©m logar no console
            const consoleMethod = type === 'error' ? 'error' : type === 'warning' ? 'warn' : 'log';
            console[consoleMethod](`[${timestamp}] ${message}`);
        }

        // Exibir chave API
        document.getElementById('api-key-display').textContent = API_KEY;

        // Capturar erros do Google Maps
        window.gm_authFailure = function() {
            log('‚ùå ERRO DE AUTENTICA√á√ÉO: Chave API inv√°lida ou sem permiss√µes', 'error');
            log('Verifique se a chave est√° correta e se as APIs est√£o habilitadas no Google Cloud Console', 'warning');
        };

        // Interceptar console.error para capturar erros do Google Maps
        const originalError = console.error;
        console.error = function(...args) {
            const message = args.join(' ');
            if (message.includes('Google Maps') || message.includes('google.maps')) {
                log(`Console Error: ${message}`, 'error');
            }
            originalError.apply(console, args);
        };

        // Carregar Google Maps
        function carregarGoogleMaps() {
            log('Iniciando carregamento do Google Maps API...', 'info');

            return new Promise((resolve, reject) => {
                // Verificar se j√° est√° carregado
                if (typeof google !== 'undefined' && google.maps) {
                    log('‚úì Google Maps j√° estava carregado', 'success');
                    resolve();
                    return;
                }

                log(`Carregando script: https://maps.googleapis.com/maps/api/js?key=${API_KEY.substring(0, 20)}...`, 'info');

                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&libraries=places,geometry`;
                script.async = true;
                script.defer = true;

                script.onload = () => {
                    log('‚úì Script carregado com sucesso', 'success');

                    // Aguardar um pouco para garantir que google.maps est√° dispon√≠vel
                    setTimeout(() => {
                        if (typeof google !== 'undefined' && google.maps) {
                            log('‚úì Google Maps inicializado corretamente', 'success');
                            log(`Vers√£o da API: ${google.maps.version}`, 'info');
                            resolve();
                        } else {
                            const msg = 'Erro: google.maps n√£o est√° dispon√≠vel ap√≥s carregar script';
                            log(msg, 'error');
                            reject(new Error(msg));
                        }
                    }, 500);
                };

                script.onerror = (error) => {
                    const msg = 'Erro ao carregar script do Google Maps. Verifique conex√£o com internet.';
                    log(msg, 'error');
                    log(`Detalhes: ${error}`, 'error');
                    reject(new Error(msg));
                };

                document.head.appendChild(script);
                log('Script adicionado ao DOM', 'info');
            });
        }

        // Inicializar mapa
        async function inicializarMapa() {
            try {
                log('Criando mapa...', 'info');

                const mapElement = document.getElementById('map');
                const recife = { lat: -8.0476, lng: -34.8770 };

                const map = new google.maps.Map(mapElement, {
                    center: recife,
                    zoom: 12,
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                });

                log('‚úì Mapa criado com sucesso', 'success');

                // Adicionar marcador
                new google.maps.Marker({
                    position: recife,
                    map: map,
                    title: 'Recife, PE'
                });

                log('‚úì Marcador adicionado ao mapa', 'success');

                // Inicializar geocoder
                geocoder = new google.maps.Geocoder();
                log('‚úì Geocoder inicializado', 'success');

            } catch (error) {
                log(`‚ùå Erro ao criar mapa: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
            }
        }

        // Testar geocodifica√ß√£o
        async function testarGeocodificacao() {
            const resultadoDiv = document.getElementById('resultado-geo');
            const endereco = document.getElementById('endereco-teste').value;

            log(`Testando geocodifica√ß√£o: "${endereco}"`, 'info');

            resultadoDiv.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p class="text-blue-800">Processando...</p>
                </div>
            `;

            try {
                if (!geocoder) {
                    throw new Error('Geocoder n√£o inicializado. Aguarde o carregamento do mapa.');
                }

                geocoder.geocode({ address: endereco }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const location = results[0].geometry.location;
                        const lat = location.lat();
                        const lng = location.lng();

                        log(`‚úì Geocodifica√ß√£o bem-sucedida: (${lat}, ${lng})`, 'success');

                        resultadoDiv.innerHTML = `
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <p class="font-semibold text-green-900 mb-2">‚úì Sucesso!</p>
                                <p class="text-sm text-gray-700"><strong>Endere√ßo:</strong> ${results[0].formatted_address}</p>
                                <p class="text-sm text-gray-700"><strong>Latitude:</strong> ${lat}</p>
                                <p class="text-sm text-gray-700"><strong>Longitude:</strong> ${lng}</p>
                            </div>
                        `;
                    } else {
                        const msg = `Geocodifica√ß√£o falhou: ${status}`;
                        log(`‚ùå ${msg}`, 'error');

                        resultadoDiv.innerHTML = `
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <p class="text-red-800"><strong>Erro:</strong> ${msg}</p>
                            </div>
                        `;
                    }
                });

            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');

                resultadoDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-red-800"><strong>Erro:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }

        // Iniciar diagn√≥stico
        async function iniciarDiagnostico() {
            log('=== INICIANDO DIAGN√ìSTICO ===', 'info');
            log(`Navegador: ${navigator.userAgent}`, 'info');
            log(`Conex√£o online: ${navigator.onLine ? 'Sim' : 'N√£o'}`, navigator.onLine ? 'success' : 'error');

            try {
                await carregarGoogleMaps();
                await inicializarMapa();
                log('=== DIAGN√ìSTICO CONCLU√çDO COM SUCESSO ===', 'success');
            } catch (error) {
                log(`=== DIAGN√ìSTICO FALHOU: ${error.message} ===`, 'error');
            }
        }

        // Executar ao carregar p√°gina
        window.onload = iniciarDiagnostico;
    </script>
</body>
</html>
